---
- hosts : all
  remote_user : root
  connection: local
  become : yes
  tasks:
    - name: Update and upgrade existing apt packages
      become: true
      apt:
        upgrade: yes
        update_cache: yes
    - name: installing dnf
      apt:
        name: dnf
        state: present
    - name: install required packages
      yum:
        name: "{{packages}}"
        state: present
      var:
        packages:
          - centos-release-scl
          - httpd24-httpd
          - rh-php73
          - rh-php73-php
          - rh-php73-php-mbstring
          - rh-php73-php-mysqlnd
          - rh-php73-php-gd
          - rh-php73-php-xml
          - mariadb-server
          - mariadb
      
    - name: Start and enable Apache (httpd) service
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Start and enable MariaDB (MySQL) service
      service:
        name: mariadb
        state: started
        enabled: yes

    - name: Secure the MariaDB installation
      command: mysql_secure_installation < /root/mysql_secure_installation_input.txt
      args:
        creates: /root/mysql_secure_installation_input.txt

    - name: Download MediaWiki
      get_url:
        url: "https://releases.wikimedia.org/mediawiki/{{ mediawiki_version }}/mediawiki-{{ mediawiki_version }}.tar.gz"
        dest: /tmp/mediawiki.tar.gz
        mode: 0644
      vars:
        mediawiki_version: "1.37.1"  # Replace with the desired MediaWiki version

    - name: Extract MediaWiki archive
      unarchive:
        src: /tmp/mediawiki.tar.gz
        dest: /var/www/html/
        remote_src: yes
        owner: apache
        group: apache
        mode: 0755

    - name: Create MediaWiki configuration directory
      file:
        path: /var/www/html/mediawiki/config
        state: directory
        owner: apache
        group: apache
        mode: 0755

    - name: Clean up temporary files
      file:
        path: /tmp/mediawiki.tar.gz
        state: absent

    - name: Set SELinux to allow httpd to connect to the network (if SELinux is enabled)
      selinux:
        policy: targeted
        state: permissive
        type: httpd_t

